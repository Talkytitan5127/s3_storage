name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run gofmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi
      
      - name: Run go vet
        run: go vet ./...
      
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
      
      - name: Run golangci-lint
        run: golangci-lint run --timeout=5m

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Download dependencies
        run: go mod download
      
      - name: Run unit tests
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./internal/...
      
      - name: Generate coverage report
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: s3storage
          POSTGRES_PASSWORD: s3storage_pass
          POSTGRES_DB: s3storage
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          cd tests/integration
          pip install -r requirements.txt
      
      - name: Generate Python gRPC code
        run: |
          cd tests/integration
          bash generate_grpc.sh
      
      - name: Run database migrations
        env:
          DATABASE_URL: postgres://s3storage:s3storage_pass@localhost:5432/s3storage?sslmode=disable
        run: |
          go run cmd/migrate/main.go || echo "Migration tool not yet implemented"
      
      - name: Run integration tests (Go)
        env:
          DATABASE_URL: postgres://s3storage:s3storage_pass@localhost:5432/s3storage?sslmode=disable
        run: |
          go test -v -tags=integration ./tests/... || echo "Go integration tests not yet implemented"

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          cd tests/integration
          pip install -r requirements.txt
      
      - name: Generate Python gRPC code
        run: |
          cd tests/integration
          bash generate_grpc.sh
      
      - name: Start Docker Compose services
        run: |
          docker-compose -f docker-compose.test.yml up -d --build
          sleep 30  # Wait for services to be ready
      
      - name: Check service health
        run: |
          curl -f http://localhost:8080/health || exit 1
      
      - name: Run E2E tests
        run: |
          cd tests/integration
          pytest test_e2e.py -v --tb=short --maxfail=3
      
      - name: Run gRPC tests
        run: |
          cd tests/integration
          pytest test_grpc.py -v --tb=short --maxfail=3
      
      - name: Run concurrent tests
        run: |
          cd tests/integration
          pytest test_concurrent.py -v --tb=short --maxfail=3 -m "not slow"
      
      - name: Collect Docker logs on failure
        if: failure()
        run: |
          docker-compose -f docker-compose.test.yml logs > docker-logs.txt
      
      - name: Upload Docker logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: docker-logs
          path: docker-logs.txt
      
      - name: Stop Docker Compose services
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build API Gateway image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: cmd/api-gateway/Dockerfile
          push: false
          tags: s3storage/api-gateway:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Storage Server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: cmd/storage-server/Dockerfile
          push: false
          tags: s3storage/storage-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, e2e-tests, build]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Build: ${{ needs.build.result }}"
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi
          
          echo "✅ All tests passed"